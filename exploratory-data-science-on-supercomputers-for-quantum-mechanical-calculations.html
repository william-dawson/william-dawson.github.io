<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">

    <title>Exploratory data science on supercomputers for quantum mechanical calculations &ndash; william-dawson.github.io</title>

    <!-- Meta -->
    <meta name="description" content="william-dawson.github.io &ndash; ">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">

    <!-- Social -->
    <meta property="article:author" content="William Dawson" />
    <meta property="article:section" content="Lessons" />
    <meta property="article:published_time" content="2024-06-05" />

    <meta property="og:type" content="article"/>
    <meta property="og:title" content="Exploratory data science on supercomputers for quantum mechanical calculations"/>
    <meta property="og:description" content="I share a technical note we wrote about some python libraries we&#39;ve written for electronic structure calculations."/>
    <meta property="og:site_name" content="william-dawson.github.io" />
    <meta property="og:url" content="https://william-dawson.github.io/exploratory-data-science-on-supercomputers-for-quantum-mechanical-calculations.html"/>

    <meta name="twitter:card" content="summary">
    <meta name="twitter:title" content="Exploratory data science on supercomputers for quantum mechanical calculations">
    <meta name="twitter:description" content="I share a technical note we wrote about some python libraries we&#39;ve written for electronic structure calculations.">
    <meta name="twitter:url" content="https://william-dawson.github.io/exploratory-data-science-on-supercomputers-for-quantum-mechanical-calculations.html">

    <!-- Feed -->
    <link rel="alternate" type="application/atom+xml" href="https://william-dawson.github.io/feeds/all.atom.xml" title="william-dawson.github.io Atom Feed" />

    <!-- CSS -->
    <link rel="stylesheet" type="text/css" href="https://fonts.googleapis.com/css?family=Open+Sans:regular,bold">
    <link rel="stylesheet" type="text/css" href="https://william-dawson.github.io/theme/css/w3.css">
    <link rel="stylesheet" type="text/css" href="https://william-dawson.github.io/theme/css/style.css">
    <link rel="stylesheet" type="text/css" href="https://william-dawson.github.io/theme/css/jqcloud.css">
    <link rel="stylesheet" type="text/css" href="https://william-dawson.github.io/theme/css/font-awesome.min.css">
    <link rel="stylesheet" type="text/css" href="https://william-dawson.github.io/theme/css/pygments-highlight-github.css">

    <!-- Icon -->

    <!-- JavaScript -->
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.1.0/jquery.min.js"></script>
    <script src="https://william-dawson.github.io/theme/js/jqcloud.min.js"></script>
    <script>
    MathJax = {
      tex: {
        inlineMath: [['$', '$'], ['\\(', '\\)']]
      },
      svg: {
        fontCache: 'global'
      }
    };
    </script>
    <script type="text/javascript" id="MathJax-script" async
      src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-svg.js">
    </script>

  </head>

  <body>
    <div class="w3-row w3-card w3-white">
      <header id="header">
        <a href="https://william-dawson.github.io" id="header-logo" title="Home">WD</a>
        <nav id="header-menu">
          <ul>
            <li class="w3-bottombar w3-border-white w3-hover-border-green"><a href="https://william-dawson.github.io/pages/about.html">About</a></li>
            <li class="w3-bottombar w3-border-white w3-hover-border-green"><a href="https://william-dawson.github.io/pages/projects.html">Projects</a></li>
            <li class="w3-bottombar w3-border-white w3-hover-border-green"><a href="https://william-dawson.github.io/pages/publications.html">Publications</a></li>
            <li class="w3-bottombar w3-border-white w3-hover-border-green"><a href="https://william-dawson.github.io/category/lessons.html">Lessons</a></li>
            <li class="w3-bottombar w3-border-white w3-hover-border-green"><a href="https://william-dawson.github.io/category/personal-blog.html">Personal Blog</a></li>
          </ul>
        </nav>
      </header>
    </div>



    <br><br><br>

    <article>
      <header class="w3-container col-main">
        <h1>Exploratory data science on supercomputers for quantum mechanical calculations</h1>
        <div class="post-info">
          <div class="w3-opacity w3-margin-right w3-margin-bottom" style="flex-grow: 1;">
            <span><time datetime="2024-06-05T11:00:00+09:00">Wed 05 June 2024</time> in <a href="https://william-dawson.github.io/category/lessons.html" title="All articles in category Lessons">Lessons</a></span>
          </div>
          <div>
            <span class="w3-tag w3-light-grey w3-text-green w3-hover-green">
              <a href="https://william-dawson.github.io/tag/publication.html" title="All articles with Publication tag">#publication</a>
            </span>
          </div>
        </div>
      </header>

      <br>


      <div class="col-main w3-container">
        <section id="content">
          <p>I'd like to announce a <a href="http://doi.org/10.1088/2516-1075/ad4b80">technical note of ours in Electronic Structure</a>, which highlights some of the Python packages we have been developing to help us perform electronic structure simulations. Python is a really nice glue language that allows you to setup what you want to do, join together multiple programs and methods, and finally analyze your results (statistics, visualizations, etc). It's great to use for science when running Jupyter notebooks: you can interactively build a study which contains all of the steps, decision making processes, and results in one place. Instead of writing throwaway scripts or full fledged software, Jupyter lets you develop and bundle a narrative about what you did, how and why you did it, and what you learned at the end. A lot of these ideas are summed up in the concept of <a href="https://en.wikipedia.org/wiki/Literate_programming">Literate Programming</a>, first introduced by the great computer scientist Donald Knuth in the 1980s. </p>
<p>This style of research is addictive, but you need good, expressive libraries to make sure your notebook doesn't become unwieldy. One of my colleagues said what we need is really something like a <a href="https://en.wikipedia.org/wiki/Domain-specific_language">Domain Specific Language</a> to succinctly and clearly describe the calculation steps we are doing. Building libraries to help with such intentionality is the theme of our technical note. I will go into the details of one of them below.</p>
<h2>Remote Manager and the Coffee Shop Dilemma</h2>
<p>Suppose you're sitting in a coffee shop, trying to get some Jupyter based programming done. Suddenly, you get to the part where you need to run some heavy QM calculations. At this point, you have two things you need to be worried about:</p>
<ul>
<li>The refill dilemma: the coffee may finish before the calculation does.</li>
<li>The battery dilemma: your computer's battery may be exhausted before the coffee is finished.</li>
</ul>
<p>(For my European colleagues, please understand that in other parts of the world we like to leasurely sip a mug of coffee, instead of putting the "Express" in "Espresso").</p>
<p>These problems can in principle be solved by running your calculation on a powerful remote machine. But this requires you to break the notebook workflow. Wouldn't it be nice if Jupyter had the ability to run select parts of your workflow elsewhere?</p>
<div class="highlight"><pre><span></span><code><span class="err">!</span> <span class="n">pip</span> <span class="n">install</span> <span class="o">-</span><span class="n">qq</span> <span class="n">remotemanager</span>
</code></pre></div>

<p>This is our <a href="https://l_sim.gitlab.io/remotemanager/index.html">remotemanager</a> package. At RIKEN, we have a reasonably powerful supercomputer called Hokusai "Big Waterfall", named after Japan's <a href="https://en.wikipedia.org/wiki/Hokusai">famous Ukiyo-e artist</a>. When you submit a job on Hokusai, the jobscript looks something like this:</p>
<div class="highlight"><pre><span></span><code><span class="n">template</span> <span class="o">=</span> <span class="s2">&quot;&quot;&quot;#!/bin/bash</span>
<span class="s2">#SBATCH --ntasks-per-node=#MPI#</span>
<span class="s2">#SBATCH --cpus-per-task=#OMP#</span>
<span class="s2">#SBATCH --nodes=#NODES#</span>
<span class="s2">#SBATCH --mem=#MEM:default=112G#</span>
<span class="s2">#SBATCH --partition=#QUEUE:default=mpc#</span>
<span class="s2">#SBATCH --time=#TIME:format=time:default=3600#</span>
<span class="s2">#SBATCH --account=#account#</span>

<span class="s2">export OMP_NUM_THREADS=$</span><span class="si">{SLURM_CPUS_PER_TASK}</span>
<span class="s2">export BIGDFT_MPIRUN=&quot;srun --cpus-per-task=$</span><span class="si">{SLURM_CPUS_PER_TASK}</span><span class="s2">&quot;</span>

<span class="s2"># Modules</span>
<span class="s2">module load intel</span>
<span class="s2">eval &quot;$(~/miniconda3/bin/conda shell.bash hook)&quot; # Miniconda python</span>
<span class="s2">conda activate #conda#</span>

<span class="s2"># BigDFT Installation Info</span>
<span class="s2">export PYTHONPATH=$PYTHONPATH:~/binaries/bdft/install/lib/python3.11/site-packages/</span>
<span class="s2">export BIGDFT_ROOT=~/binaries/bdft/install/bin/</span>
<span class="s2">&quot;&quot;&quot;</span>
</code></pre></div>

<p>We're skipping to the middle of the <a href="https://l_sim.gitlab.io/remotemanager/tutorials/C3_Dynamic_Templates.html">documentation</a> here, but it's a fine place to start for a blog post. In our template, I've written inside the hashes the things we'd like to modify.</p>
<div class="highlight"><pre><span></span><code><span class="kn">from</span> <span class="nn">remotemanager</span> <span class="kn">import</span> <span class="n">BaseComputer</span>
<span class="n">url</span> <span class="o">=</span> <span class="n">BaseComputer</span><span class="p">(</span><span class="n">template</span><span class="o">=</span><span class="n">template</span><span class="p">,</span> 
                   <span class="n">submitter</span><span class="o">=</span><span class="s2">&quot;sbatch&quot;</span><span class="p">,</span> <span class="c1"># since it&#39;s slurm</span>
                   <span class="n">host</span><span class="o">=</span><span class="s2">&quot;hokusai.riken.jp&quot;</span><span class="p">,</span> <span class="c1"># url of hokusai</span>
                   <span class="n">ssh_insert</span><span class="o">=</span><span class="s2">&quot;-q&quot;</span> <span class="c1"># this hides the login message</span>
                  <span class="p">)</span>
<span class="n">url</span><span class="o">.</span><span class="n">mpi</span> <span class="o">=</span> <span class="mi">16</span>
<span class="n">url</span><span class="o">.</span><span class="n">omp</span> <span class="o">=</span> <span class="mi">7</span>
<span class="n">url</span><span class="o">.</span><span class="n">nodes</span> <span class="o">=</span> <span class="mi">1</span>
<span class="n">url</span><span class="o">.</span><span class="n">conda</span> <span class="o">=</span> <span class="s2">&quot;bigdft&quot;</span>
<span class="n">url</span><span class="o">.</span><span class="n">account</span> <span class="o">=</span> <span class="s2">&quot;RB######&quot;</span>
<span class="nb">print</span><span class="p">(</span><span class="n">url</span><span class="o">.</span><span class="n">script</span><span class="p">())</span>
</code></pre></div>

<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span class="normal"> 1</span>
<span class="normal"> 2</span>
<span class="normal"> 3</span>
<span class="normal"> 4</span>
<span class="normal"> 5</span>
<span class="normal"> 6</span>
<span class="normal"> 7</span>
<span class="normal"> 8</span>
<span class="normal"> 9</span>
<span class="normal">10</span>
<span class="normal">11</span>
<span class="normal">12</span>
<span class="normal">13</span>
<span class="normal">14</span>
<span class="normal">15</span>
<span class="normal">16</span>
<span class="normal">17</span>
<span class="normal">18</span>
<span class="normal">19</span>
<span class="normal">20</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="ch">#!/bin/bash</span>
<span class="c1">#SBATCH --ntasks-per-node=16</span>
<span class="c1">#SBATCH --cpus-per-task=7</span>
<span class="c1">#SBATCH --nodes=1</span>
<span class="c1">#SBATCH --mem=112G</span>
<span class="c1">#SBATCH --partition=mpc</span>
<span class="c1">#SBATCH --time=01:00:00</span>
<span class="c1">#SBATCH --account=RB######</span>

<span class="nb">export</span><span class="w"> </span><span class="nv">OMP_NUM_THREADS</span><span class="o">=</span><span class="si">${</span><span class="nv">SLURM_CPUS_PER_TASK</span><span class="si">}</span>
<span class="nb">export</span><span class="w"> </span><span class="nv">BIGDFT_MPIRUN</span><span class="o">=</span><span class="s2">&quot;srun --cpus-per-task=</span><span class="si">${</span><span class="nv">SLURM_CPUS_PER_TASK</span><span class="si">}</span><span class="s2">&quot;</span>

<span class="c1"># Modules</span>
module<span class="w"> </span>load<span class="w"> </span>intel
<span class="nb">eval</span><span class="w"> </span><span class="s2">&quot;</span><span class="k">$(</span>~/miniconda3/bin/conda<span class="w"> </span>shell.bash<span class="w"> </span>hook<span class="k">)</span><span class="s2">&quot;</span><span class="w"> </span><span class="c1"># Miniconda python</span>
conda<span class="w"> </span>activate<span class="w"> </span>bigdft

<span class="c1"># BigDFT Installation Info</span>
<span class="nb">export</span><span class="w"> </span><span class="nv">PYTHONPATH</span><span class="o">=</span><span class="nv">$PYTHONPATH</span>:~/binaries/bdft/install/lib/python3.11/site-packages/
<span class="nb">export</span><span class="w"> </span><span class="nv">BIGDFT_ROOT</span><span class="o">=</span>~/binaries/bdft/install/bin/
</code></pre></div></td></tr></table></div>

<p>Now let's imagine I want to run a BigDFT calculation in my notebook. I could do this on my current machine, but how much better it would be to do it on Hokusai.</p>
<div class="highlight"><pre><span></span><code><span class="kn">from</span> <span class="nn">remotemanager</span> <span class="kn">import</span> <span class="n">SanzuFunction</span>
<span class="nd">@SanzuFunction</span><span class="p">(</span><span class="n">url</span><span class="o">=</span><span class="n">url</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">calc_bigdft</span><span class="p">(</span><span class="n">geom</span><span class="p">):</span>
    <span class="kn">from</span> <span class="nn">BigDFT.Database.Molecules</span> <span class="kn">import</span> <span class="n">get_molecule</span>
    <span class="kn">from</span> <span class="nn">BigDFT.Calculators</span> <span class="kn">import</span> <span class="n">SystemCalculator</span>
    <span class="kn">from</span> <span class="nn">BigDFT.Inputfiles</span> <span class="kn">import</span> <span class="n">Inputfile</span>
    <span class="n">calc</span> <span class="o">=</span> <span class="n">SystemCalculator</span><span class="p">()</span>
    <span class="n">inp</span> <span class="o">=</span> <span class="n">Inputfile</span><span class="p">()</span>
    <span class="n">inp</span><span class="o">.</span><span class="n">set_xc</span><span class="p">(</span><span class="s2">&quot;PBE&quot;</span><span class="p">)</span> <span class="p">;</span> <span class="n">inp</span><span class="o">.</span><span class="n">set_hgrid</span><span class="p">(</span><span class="mf">0.37</span><span class="p">)</span>
    <span class="n">log</span> <span class="o">=</span> <span class="n">calc</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="n">sys</span><span class="o">=</span><span class="n">get_molecule</span><span class="p">(</span><span class="n">geom</span><span class="p">),</span> <span class="nb">input</span><span class="o">=</span><span class="n">inp</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="n">geom</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">log</span><span class="o">.</span><span class="n">energy</span>
</code></pre></div>

<div class="highlight"><pre><span></span><code><span class="c1"># for demonstration, we don&#39;t need so many cores</span>
<span class="n">url</span><span class="o">.</span><span class="n">mpi</span> <span class="o">=</span> <span class="mi">1</span>
<span class="n">url</span><span class="o">.</span><span class="n">omp</span> <span class="o">=</span> <span class="mi">1</span>
<span class="n">url</span><span class="o">.</span><span class="n">mem</span> <span class="o">=</span> <span class="s2">&quot;1G&quot;</span>
</code></pre></div>

<div class="highlight"><pre><span></span><code><span class="n">calc_bigdft</span><span class="p">(</span><span class="s2">&quot;H2O&quot;</span><span class="p">)</span>
</code></pre></div>

<div class="highlight"><pre><span></span><code><span class="nv">appended</span><span class="w"> </span><span class="nv">run</span><span class="w"> </span><span class="nv">runner</span><span class="o">-</span><span class="mi">0</span>
<span class="nv">Running</span><span class="w"> </span><span class="nv">Dataset</span>
<span class="nv">assessing</span><span class="w"> </span><span class="nv">run</span><span class="w"> </span><span class="k">for</span><span class="w"> </span><span class="nv">runner</span><span class="w"> </span><span class="nv">dataset</span><span class="o">-</span><span class="mi">741</span><span class="nv">a12c3</span><span class="o">-</span><span class="nv">runner</span><span class="o">-</span><span class="mi">0</span>...<span class="w"> </span><span class="nv">running</span>
<span class="nv">Transferring</span><span class="w"> </span><span class="mi">4</span><span class="w"> </span><span class="nv">Files</span>...<span class="w"> </span><span class="nv">Done</span>
<span class="nv">Fetching</span><span class="w"> </span><span class="nv">results</span>
<span class="nv">Transferring</span><span class="w"> </span><span class="mi">1</span><span class="w"> </span><span class="nv">File</span>...<span class="w"> </span><span class="nv">Done</span>

<span class="o">-</span><span class="mi">17</span>.<span class="mi">22109431242808</span>
</code></pre></div>

<p>It's just that simple. And don't worry, if you decide to shut down your computer and go to the next shop, these results are cached and immediately available upon notebook restart.</p>
<div class="highlight"><pre><span></span><code><span class="n">calc_bigdft</span><span class="p">(</span><span class="s2">&quot;H2O&quot;</span><span class="p">)</span>
</code></pre></div>

<div class="highlight"><pre><span></span><code><span class="nv">runner</span><span class="w"> </span><span class="nv">runner</span><span class="o">-</span><span class="mi">0</span><span class="w"> </span><span class="nv">already</span><span class="w"> </span><span class="nv">exists</span>
<span class="nv">Running</span><span class="w"> </span><span class="nv">Dataset</span>
<span class="nv">assessing</span><span class="w"> </span><span class="nv">run</span><span class="w"> </span><span class="k">for</span><span class="w"> </span><span class="nv">runner</span><span class="w"> </span><span class="nv">dataset</span><span class="o">-</span><span class="mi">741</span><span class="nv">a12c3</span><span class="o">-</span><span class="nv">runner</span><span class="o">-</span><span class="mi">0</span>...<span class="w"> </span><span class="nv">ignoring</span><span class="w"> </span><span class="nv">run</span><span class="w"> </span><span class="k">for</span><span class="w"> </span><span class="nv">successful</span><span class="w"> </span><span class="nv">runner</span>
<span class="nv">Fetching</span><span class="w"> </span><span class="nv">results</span>
<span class="nv">No</span><span class="w"> </span><span class="nv">Transfer</span><span class="w"> </span><span class="nv">Required</span>

<span class="o">-</span><span class="mi">17</span>.<span class="mi">22109431242808</span>
</code></pre></div>

<p>A lot of times I think of a "scaling up" pattern with remotemanager. First I might define a function I want to try and run it on something small. Then as soon as I need to do something heavy, I promote it to a <code>SanzuFunction</code> to run on a more powerful machine.</p>
<p>We have just fetched the energy here. But maybe we'd also like to read the logfile and get out the forces too. We could've used the <code>extra_files_recv</code> option to pull the log back to our local machine. Or we can run another script on the login node and avoid moving files around (some data gets really big).</p>
<div class="highlight"><pre><span></span><code><span class="n">front_template</span> <span class="o">=</span> <span class="s2">&quot;&quot;&quot;#!/bin/bash</span>
<span class="s2"># suppress that this writes to standard error on login nodes</span>
<span class="s2">module load intel &gt; /dev/null 2&gt;&amp;1</span>
<span class="s2">eval &quot;$(~/miniconda3/bin/conda shell.bash hook)&quot; # Miniconda python</span>
<span class="s2">conda activate #conda#</span>
<span class="s2">export PYTHONPATH=$PYTHONPATH:~/binaries/bdft/install/lib/python3.11/site-packages/</span>
<span class="s2">&quot;&quot;&quot;</span>
<span class="n">furl</span> <span class="o">=</span> <span class="n">BaseComputer</span><span class="p">(</span><span class="n">template</span><span class="o">=</span><span class="n">front_template</span><span class="p">,</span> 
                    <span class="n">host</span><span class="o">=</span><span class="s2">&quot;hokusai.riken.jp&quot;</span><span class="p">,</span> <span class="n">ssh_insert</span><span class="o">=</span><span class="s2">&quot;-q&quot;</span><span class="p">)</span>
<span class="n">furl</span><span class="o">.</span><span class="n">conda</span> <span class="o">=</span> <span class="s2">&quot;bigdft&quot;</span>
</code></pre></div>

<p>An alternative way to do remote runs is with Jupyter magics.</p>
<div class="highlight"><pre><span></span><code><span class="o">%</span><span class="n">load_ext</span> <span class="n">remotemanager</span>
</code></pre></div>

<div class="highlight"><pre><span></span><code><span class="o">%%</span><span class="n">sanzu</span> <span class="n">url</span><span class="o">=</span><span class="n">furl</span><span class="p">,</span> <span class="n">asynchronous</span><span class="o">=</span><span class="kc">False</span>
<span class="o">%%</span><span class="n">sargs</span> <span class="n">geom</span><span class="o">=</span><span class="s2">&quot;H2O&quot;</span>
<span class="kn">from</span> <span class="nn">BigDFT.Logfiles</span> <span class="kn">import</span> <span class="n">Logfile</span>
<span class="n">log</span> <span class="o">=</span> <span class="n">Logfile</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;log-</span><span class="si">{</span><span class="n">geom</span><span class="si">}</span><span class="s1">.yaml&#39;</span><span class="p">)</span>
<span class="n">log</span><span class="o">.</span><span class="n">forces</span>
</code></pre></div>

<div class="highlight"><pre><span></span><code><span class="nv">appended</span><span class="w"> </span><span class="nv">run</span><span class="w"> </span><span class="nv">runner</span><span class="o">-</span><span class="mi">0</span>
<span class="nv">Running</span><span class="w"> </span><span class="nv">Dataset</span>
<span class="nv">assessing</span><span class="w"> </span><span class="nv">run</span><span class="w"> </span><span class="k">for</span><span class="w"> </span><span class="nv">runner</span><span class="w"> </span><span class="nv">dataset</span><span class="o">-</span><span class="mi">9208</span><span class="nv">d5eb</span><span class="o">-</span><span class="nv">runner</span><span class="o">-</span><span class="mi">0</span>...<span class="w"> </span><span class="nv">running</span>
<span class="nv">Transferring</span><span class="w"> </span><span class="mi">4</span><span class="w"> </span><span class="nv">Files</span>...<span class="w"> </span><span class="nv">Done</span>
<span class="nv">Fetching</span><span class="w"> </span><span class="nv">results</span>
<span class="nv">Transferring</span><span class="w"> </span><span class="mi">1</span><span class="w"> </span><span class="nv">File</span>...<span class="w"> </span><span class="nv">Done</span>

[{<span class="s1">&#39;O&#39;</span>:<span class="w"> </span>[<span class="mi">3</span>.<span class="mi">388131789017</span><span class="nv">e</span><span class="o">-</span><span class="mi">21</span>,<span class="w"> </span><span class="mi">4</span>.<span class="mi">614988304672</span><span class="nv">e</span><span class="o">-</span><span class="mi">07</span>,<span class="w"> </span><span class="mi">0</span>.<span class="mi">01480963171734</span>]},
<span class="w"> </span>{<span class="s1">&#39;H&#39;</span>:<span class="w"> </span>[<span class="o">-</span><span class="mi">6</span>.<span class="mi">617444900424</span><span class="nv">e</span><span class="o">-</span><span class="mi">24</span>,<span class="w"> </span><span class="mi">0</span>.<span class="mi">009705317490556</span>,<span class="w"> </span><span class="o">-</span><span class="mi">0</span>.<span class="mi">007404637128436</span>]},
<span class="w"> </span>{<span class="s1">&#39;H&#39;</span>:<span class="w"> </span>[<span class="mi">6</span>.<span class="mi">617444900424</span><span class="nv">e</span><span class="o">-</span><span class="mi">24</span>,<span class="w"> </span><span class="o">-</span><span class="mi">0</span>.<span class="mi">009705778989387</span>,<span class="w"> </span><span class="o">-</span><span class="mi">0</span>.<span class="mi">007404994588901</span>]}]
</code></pre></div>

<p>The asynchronous part here is because Hokusai staff don't like us running background processes on the front end. </p>
<h2>Dataset Calculations - Training a Forcefield</h2>
<p>Data parallel calculations are another example of the "scaling up" pattern. For this, remotemanager provides the <code>Dataset</code> class. Let's say I want to compute a potential energy surface (following a different <a href="https://l_sim.gitlab.io/bigdft-suite/lessons/Gaussian.html">BigDFT Tutorial</a>).</p>
<div class="highlight"><pre><span></span><code><span class="kn">from</span> <span class="nn">BigDFT.IO</span> <span class="kn">import</span> <span class="n">read_pdb</span>
<span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="s2">&quot;mol.pdb&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">ifile</span><span class="p">:</span>
    <span class="n">sys</span> <span class="o">=</span> <span class="n">read_pdb</span><span class="p">(</span><span class="n">ifile</span><span class="p">)</span>
</code></pre></div>

<div class="highlight"><pre><span></span><code><span class="n">_</span> <span class="o">=</span> <span class="n">sys</span><span class="o">.</span><span class="n">display</span><span class="p">()</span>
</code></pre></div>

<div id="3dmolviewer_1717571739653675"  style="position: relative; width: 400px; height: 300px;">
        <p id="3dmolwarning_1717571739653675" style="background-color:#ffcccc;color:black">3Dmol.js failed to load for some reason.  Please check your browser console for error messages.<br></p>
        </div>
<script>

var loadScriptAsync = function(uri){
  return new Promise((resolve, reject) => {
    //this is to ignore the existence of requirejs amd
    var savedexports, savedmodule;
    if (typeof exports !== 'undefined') savedexports = exports;
    else exports = {}
    if (typeof module !== 'undefined') savedmodule = module;
    else module = {}

    var tag = document.createElement('script');
    tag.src = uri;
    tag.async = true;
    tag.onload = () => {
        exports = savedexports;
        module = savedmodule;
        resolve();
    };
  var firstScriptTag = document.getElementsByTagName('script')[0];
  firstScriptTag.parentNode.insertBefore(tag, firstScriptTag);
});
};

if(typeof $3Dmolpromise === 'undefined') {
$3Dmolpromise = null;
  $3Dmolpromise = loadScriptAsync('https://cdnjs.cloudflare.com/ajax/libs/3Dmol/2.1.0/3Dmol-min.js');
}

var viewer_1717571739653675 = null;
var warn = document.getElementById("3dmolwarning_1717571739653675");
if(warn) {
    warn.parentNode.removeChild(warn);
}
$3Dmolpromise.then(function() {
var viewergrid_1717571739653675 = null;
viewergrid_1717571739653675 = $3Dmol.createViewerGrid(document.getElementById("3dmolviewer_1717571739653675"),{rows: 1, cols: 1, control_all: false},{backgroundColor:"white"});
viewer_1717571739653675 = viewergrid_1717571739653675[0][0];
viewergrid_1717571739653675[0][0].zoomTo(); viewergrid_1717571739653675[0][0].addModelsAsFrames("MODEL 0\nHETATM    1 C    FRA A   0      -0.850  -0.034  -0.200  1.00  0.00       B   C  \nHETATM    2 H    FRA A   0      -0.941   0.869  -0.822  1.00  0.00       B   H  \nHETATM    3 H    FRA A   0      -1.422  -0.869  -0.647  1.00  0.00       B   H  \nHETATM    4 H    FRA A   0      -1.203   0.166   0.822  1.00  0.00       B   H  \nHETATM    5 S    FRA A   1       0.900  -0.512  -0.122  1.00  0.00       B   S  \nHETATM    6 H    FRA A   1       1.422   0.578   0.425  1.00  0.00       B   H  \nENDMDL\n","pdb",{"keepH": "true"});
    viewergrid_1717571739653675[0][0].setStyle({"model": -1},{"line": {"color": "black"}});
    viewergrid_1717571739653675[0][0].addModelsAsFrames("MODEL 0\nHETATM    1 C    FRA A   0      -0.850  -0.034  -0.200  1.00  0.00       B   C  \nHETATM    2 H    FRA A   0      -0.941   0.869  -0.822  1.00  0.00       B   H  \nHETATM    3 H    FRA A   0      -1.422  -0.869  -0.647  1.00  0.00       B   H  \nHETATM    4 H    FRA A   0      -1.203   0.166   0.822  1.00  0.00       B   H  \nHETATM    5 S    FRA A   1       0.900  -0.512  -0.122  1.00  0.00       B   S  \nHETATM    6 H    FRA A   1       1.422   0.578   0.425  1.00  0.00       B   H  \nENDMDL\n","pdb",{"keepH": "true"});
    viewergrid_1717571739653675[0][0].setStyle({"model": -1, "serial": 1},{"sphere": {"scale": 0.2, "color": "#FF0000"}});
    viewergrid_1717571739653675[0][0].addModelsAsFrames("MODEL 0\nHETATM    1 C    FRA A   0      -0.850  -0.034  -0.200  1.00  0.00       B   C  \nHETATM    2 H    FRA A   0      -0.941   0.869  -0.822  1.00  0.00       B   H  \nHETATM    3 H    FRA A   0      -1.422  -0.869  -0.647  1.00  0.00       B   H  \nHETATM    4 H    FRA A   0      -1.203   0.166   0.822  1.00  0.00       B   H  \nHETATM    5 S    FRA A   1       0.900  -0.512  -0.122  1.00  0.00       B   S  \nHETATM    6 H    FRA A   1       1.422   0.578   0.425  1.00  0.00       B   H  \nENDMDL\n","pdb",{"keepH": "true"});
    viewergrid_1717571739653675[0][0].setStyle({"model": -1, "serial": 2},{"sphere": {"scale": 0.2, "color": "#FF0000"}});
    viewergrid_1717571739653675[0][0].addModelsAsFrames("MODEL 0\nHETATM    1 C    FRA A   0      -0.850  -0.034  -0.200  1.00  0.00       B   C  \nHETATM    2 H    FRA A   0      -0.941   0.869  -0.822  1.00  0.00       B   H  \nHETATM    3 H    FRA A   0      -1.422  -0.869  -0.647  1.00  0.00       B   H  \nHETATM    4 H    FRA A   0      -1.203   0.166   0.822  1.00  0.00       B   H  \nHETATM    5 S    FRA A   1       0.900  -0.512  -0.122  1.00  0.00       B   S  \nHETATM    6 H    FRA A   1       1.422   0.578   0.425  1.00  0.00       B   H  \nENDMDL\n","pdb",{"keepH": "true"});
    viewergrid_1717571739653675[0][0].setStyle({"model": -1, "serial": 3},{"sphere": {"scale": 0.2, "color": "#FF0000"}});
    viewergrid_1717571739653675[0][0].addModelsAsFrames("MODEL 0\nHETATM    1 C    FRA A   0      -0.850  -0.034  -0.200  1.00  0.00       B   C  \nHETATM    2 H    FRA A   0      -0.941   0.869  -0.822  1.00  0.00       B   H  \nHETATM    3 H    FRA A   0      -1.422  -0.869  -0.647  1.00  0.00       B   H  \nHETATM    4 H    FRA A   0      -1.203   0.166   0.822  1.00  0.00       B   H  \nHETATM    5 S    FRA A   1       0.900  -0.512  -0.122  1.00  0.00       B   S  \nHETATM    6 H    FRA A   1       1.422   0.578   0.425  1.00  0.00       B   H  \nENDMDL\n","pdb",{"keepH": "true"});
    viewergrid_1717571739653675[0][0].setStyle({"model": -1, "serial": 4},{"sphere": {"scale": 0.2, "color": "#FF0000"}});
    viewergrid_1717571739653675[0][0].addModelsAsFrames("MODEL 0\nHETATM    1 C    FRA A   0      -0.850  -0.034  -0.200  1.00  0.00       B   C  \nHETATM    2 H    FRA A   0      -0.941   0.869  -0.822  1.00  0.00       B   H  \nHETATM    3 H    FRA A   0      -1.422  -0.869  -0.647  1.00  0.00       B   H  \nHETATM    4 H    FRA A   0      -1.203   0.166   0.822  1.00  0.00       B   H  \nHETATM    5 S    FRA A   1       0.900  -0.512  -0.122  1.00  0.00       B   S  \nHETATM    6 H    FRA A   1       1.422   0.578   0.425  1.00  0.00       B   H  \nENDMDL\n","pdb",{"keepH": "true"});
    viewergrid_1717571739653675[0][0].setStyle({"model": -1},{"line": {"color": "black"}});
    viewergrid_1717571739653675[0][0].addModelsAsFrames("MODEL 0\nHETATM    1 C    FRA A   0      -0.850  -0.034  -0.200  1.00  0.00       B   C  \nHETATM    2 H    FRA A   0      -0.941   0.869  -0.822  1.00  0.00       B   H  \nHETATM    3 H    FRA A   0      -1.422  -0.869  -0.647  1.00  0.00       B   H  \nHETATM    4 H    FRA A   0      -1.203   0.166   0.822  1.00  0.00       B   H  \nHETATM    5 S    FRA A   1       0.900  -0.512  -0.122  1.00  0.00       B   S  \nHETATM    6 H    FRA A   1       1.422   0.578   0.425  1.00  0.00       B   H  \nENDMDL\n","pdb",{"keepH": "true"});
    viewergrid_1717571739653675[0][0].setStyle({"model": -1, "serial": 5},{"sphere": {"scale": 0.2, "color": "#7F00FF"}});
    viewergrid_1717571739653675[0][0].addModelsAsFrames("MODEL 0\nHETATM    1 C    FRA A   0      -0.850  -0.034  -0.200  1.00  0.00       B   C  \nHETATM    2 H    FRA A   0      -0.941   0.869  -0.822  1.00  0.00       B   H  \nHETATM    3 H    FRA A   0      -1.422  -0.869  -0.647  1.00  0.00       B   H  \nHETATM    4 H    FRA A   0      -1.203   0.166   0.822  1.00  0.00       B   H  \nHETATM    5 S    FRA A   1       0.900  -0.512  -0.122  1.00  0.00       B   S  \nHETATM    6 H    FRA A   1       1.422   0.578   0.425  1.00  0.00       B   H  \nENDMDL\n","pdb",{"keepH": "true"});
    viewergrid_1717571739653675[0][0].setStyle({"model": -1, "serial": 6},{"sphere": {"scale": 0.2, "color": "#7F00FF"}});
    viewergrid_1717571739653675[0][0].addUnitCell({"model": -1},{"box": {"color": "black"}, "alabel": "", "blabel": "", "clabel": ""});
    viewergrid_1717571739653675[0][0].zoomTo();
viewergrid_1717571739653675[0][0].render();
});
</script>

<p>We will rotate on the axis between the two fragments.</p>
<div class="highlight"><pre><span></span><code><span class="kn">from</span> <span class="nn">remotemanager</span> <span class="kn">import</span> <span class="n">RemoteFunction</span>
<span class="c1"># Decorator lets us use this function from any remote calculation</span>
<span class="nd">@RemoteFunction</span>
<span class="k">def</span> <span class="nf">generate_rotated</span><span class="p">(</span><span class="n">geom</span><span class="p">,</span> <span class="n">angle</span><span class="p">):</span>
    <span class="kn">from</span> <span class="nn">BigDFT.IO</span> <span class="kn">import</span> <span class="n">read_pdb</span>
    <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">geom</span> <span class="o">+</span> <span class="s2">&quot;.pdb&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">ifile</span><span class="p">:</span>
        <span class="n">sys</span> <span class="o">=</span> <span class="n">read_pdb</span><span class="p">(</span><span class="n">ifile</span><span class="p">)</span>
    <span class="n">vec</span> <span class="o">=</span> <span class="p">[</span><span class="n">x</span> <span class="o">-</span> <span class="n">y</span> <span class="k">for</span> <span class="n">x</span><span class="p">,</span> <span class="n">y</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">sys</span><span class="p">[</span><span class="s2">&quot;FRA:0&quot;</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">get_position</span><span class="p">(),</span> 
                                 <span class="n">sys</span><span class="p">[</span><span class="s2">&quot;FRA:1&quot;</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">get_position</span><span class="p">())]</span>    
    <span class="n">sys</span><span class="p">[</span><span class="s2">&quot;FRA:0&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">rotate_on_axis</span><span class="p">(</span><span class="n">angle</span><span class="o">=</span><span class="n">angle</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="n">vec</span><span class="p">,</span> <span class="n">units</span><span class="o">=</span><span class="s2">&quot;degrees&quot;</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">sys</span>
</code></pre></div>

<div class="highlight"><pre><span></span><code><span class="k">def</span> <span class="nf">calc</span><span class="p">(</span><span class="n">geom</span><span class="p">,</span> <span class="n">angle</span><span class="p">,</span> <span class="n">name</span><span class="p">):</span>
    <span class="kn">from</span> <span class="nn">BigDFT.Calculators</span> <span class="kn">import</span> <span class="n">SystemCalculator</span>
    <span class="kn">from</span> <span class="nn">BigDFT.Inputfiles</span> <span class="kn">import</span> <span class="n">Inputfile</span>
    <span class="n">calc</span> <span class="o">=</span> <span class="n">SystemCalculator</span><span class="p">()</span>
    <span class="n">inp</span> <span class="o">=</span> <span class="n">Inputfile</span><span class="p">()</span>
    <span class="n">inp</span><span class="o">.</span><span class="n">set_xc</span><span class="p">(</span><span class="s2">&quot;PBE&quot;</span><span class="p">)</span> <span class="p">;</span> <span class="n">inp</span><span class="o">.</span><span class="n">set_hgrid</span><span class="p">(</span><span class="mf">0.37</span><span class="p">)</span>
    <span class="n">log</span> <span class="o">=</span> <span class="n">calc</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="n">sys</span><span class="o">=</span><span class="n">generate_rotated</span><span class="p">(</span><span class="n">geom</span><span class="p">,</span> <span class="n">angle</span><span class="p">),</span>
                   <span class="nb">input</span><span class="o">=</span><span class="n">inp</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="n">name</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">log</span><span class="o">.</span><span class="n">energy</span>
</code></pre></div>

<p>We associate a dataset with the function we just defined.</p>
<div class="highlight"><pre><span></span><code><span class="kn">from</span> <span class="nn">remotemanager</span> <span class="kn">import</span> <span class="n">Dataset</span>
<span class="n">ds</span> <span class="o">=</span> <span class="n">Dataset</span><span class="p">(</span><span class="n">calc</span><span class="p">,</span> <span class="n">url</span><span class="o">=</span><span class="n">url</span><span class="p">,</span>
             <span class="n">extra_files_send</span><span class="o">=</span><span class="s2">&quot;mol.pdb&quot;</span><span class="p">)</span>
</code></pre></div>

<p>Append each of the runs to the data and run everything.</p>
<div class="highlight"><pre><span></span><code><span class="n">steps</span> <span class="o">=</span> <span class="mi">11</span>
<span class="n">angles</span> <span class="o">=</span> <span class="p">[]</span>
<span class="k">with</span> <span class="n">ds</span><span class="o">.</span><span class="n">lazy_append</span><span class="p">()</span> <span class="k">as</span> <span class="n">la</span><span class="p">:</span>  <span class="c1"># bundling the appends is quicker</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">steps</span><span class="p">):</span>
        <span class="n">angles</span> <span class="o">+=</span> <span class="p">[</span><span class="mi">120</span> <span class="o">/</span> <span class="p">(</span><span class="n">steps</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="o">*</span> <span class="n">i</span><span class="p">]</span>
        <span class="n">la</span><span class="o">.</span><span class="n">append_run</span><span class="p">({</span><span class="s2">&quot;geom&quot;</span><span class="p">:</span> <span class="s2">&quot;mol&quot;</span><span class="p">,</span> <span class="s2">&quot;angle&quot;</span><span class="p">:</span> <span class="n">angles</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">],</span> <span class="s2">&quot;name&quot;</span><span class="p">:</span> <span class="sa">f</span><span class="s2">&quot;H2O-</span><span class="si">{</span><span class="n">i</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">})</span>
<span class="n">ds</span><span class="o">.</span><span class="n">run</span><span class="p">()</span> <span class="p">;</span> <span class="n">ds</span><span class="o">.</span><span class="n">wait</span><span class="p">()</span> <span class="p">;</span> <span class="n">ds</span><span class="o">.</span><span class="n">fetch_results</span><span class="p">()</span>
</code></pre></div>

<div class="highlight"><pre><span></span><code><span class="nv">Running</span><span class="w"> </span><span class="nv">Dataset</span>
<span class="nv">assessing</span><span class="w"> </span><span class="nv">run</span><span class="w"> </span><span class="k">for</span><span class="w"> </span><span class="nv">runner</span><span class="w"> </span><span class="nv">dataset</span><span class="o">-</span><span class="nv">eb87882e</span><span class="o">-</span><span class="nv">runner</span><span class="o">-</span><span class="mi">0</span>...<span class="w"> </span><span class="nv">running</span>
<span class="nv">assessing</span><span class="w"> </span><span class="nv">run</span><span class="w"> </span><span class="k">for</span><span class="w"> </span><span class="nv">runner</span><span class="w"> </span><span class="nv">dataset</span><span class="o">-</span><span class="nv">eb87882e</span><span class="o">-</span><span class="nv">runner</span><span class="o">-</span><span class="mi">1</span>...<span class="w"> </span><span class="nv">running</span>
<span class="nv">assessing</span><span class="w"> </span><span class="nv">run</span><span class="w"> </span><span class="k">for</span><span class="w"> </span><span class="nv">runner</span><span class="w"> </span><span class="nv">dataset</span><span class="o">-</span><span class="nv">eb87882e</span><span class="o">-</span><span class="nv">runner</span><span class="o">-</span><span class="mi">2</span>...<span class="w"> </span><span class="nv">running</span>
<span class="nv">assessing</span><span class="w"> </span><span class="nv">run</span><span class="w"> </span><span class="k">for</span><span class="w"> </span><span class="nv">runner</span><span class="w"> </span><span class="nv">dataset</span><span class="o">-</span><span class="nv">eb87882e</span><span class="o">-</span><span class="nv">runner</span><span class="o">-</span><span class="mi">3</span>...<span class="w"> </span><span class="nv">running</span>
<span class="nv">assessing</span><span class="w"> </span><span class="nv">run</span><span class="w"> </span><span class="k">for</span><span class="w"> </span><span class="nv">runner</span><span class="w"> </span><span class="nv">dataset</span><span class="o">-</span><span class="nv">eb87882e</span><span class="o">-</span><span class="nv">runner</span><span class="o">-</span><span class="mi">4</span>...<span class="w"> </span><span class="nv">running</span>
<span class="nv">assessing</span><span class="w"> </span><span class="nv">run</span><span class="w"> </span><span class="k">for</span><span class="w"> </span><span class="nv">runner</span><span class="w"> </span><span class="nv">dataset</span><span class="o">-</span><span class="nv">eb87882e</span><span class="o">-</span><span class="nv">runner</span><span class="o">-</span><span class="mi">5</span>...<span class="w"> </span><span class="nv">running</span>
<span class="nv">assessing</span><span class="w"> </span><span class="nv">run</span><span class="w"> </span><span class="k">for</span><span class="w"> </span><span class="nv">runner</span><span class="w"> </span><span class="nv">dataset</span><span class="o">-</span><span class="nv">eb87882e</span><span class="o">-</span><span class="nv">runner</span><span class="o">-</span><span class="mi">6</span>...<span class="w"> </span><span class="nv">running</span>
<span class="nv">assessing</span><span class="w"> </span><span class="nv">run</span><span class="w"> </span><span class="k">for</span><span class="w"> </span><span class="nv">runner</span><span class="w"> </span><span class="nv">dataset</span><span class="o">-</span><span class="nv">eb87882e</span><span class="o">-</span><span class="nv">runner</span><span class="o">-</span><span class="mi">7</span>...<span class="w"> </span><span class="nv">running</span>
<span class="nv">assessing</span><span class="w"> </span><span class="nv">run</span><span class="w"> </span><span class="k">for</span><span class="w"> </span><span class="nv">runner</span><span class="w"> </span><span class="nv">dataset</span><span class="o">-</span><span class="nv">eb87882e</span><span class="o">-</span><span class="nv">runner</span><span class="o">-</span><span class="mi">8</span>...<span class="w"> </span><span class="nv">running</span>
<span class="nv">assessing</span><span class="w"> </span><span class="nv">run</span><span class="w"> </span><span class="k">for</span><span class="w"> </span><span class="nv">runner</span><span class="w"> </span><span class="nv">dataset</span><span class="o">-</span><span class="nv">eb87882e</span><span class="o">-</span><span class="nv">runner</span><span class="o">-</span><span class="mi">9</span>...<span class="w"> </span><span class="nv">running</span>
<span class="nv">assessing</span><span class="w"> </span><span class="nv">run</span><span class="w"> </span><span class="k">for</span><span class="w"> </span><span class="nv">runner</span><span class="w"> </span><span class="nv">dataset</span><span class="o">-</span><span class="nv">eb87882e</span><span class="o">-</span><span class="nv">runner</span><span class="o">-</span><span class="mi">10</span>...<span class="w"> </span><span class="nv">running</span>
<span class="nv">Transferring</span><span class="w"> </span><span class="mi">25</span><span class="w"> </span><span class="nv">Files</span><span class="w"> </span><span class="nv">in</span><span class="w"> </span><span class="mi">2</span><span class="w"> </span><span class="nv">Transfers</span>...<span class="w"> </span><span class="nv">Done</span>
<span class="nv">Fetching</span><span class="w"> </span><span class="nv">results</span>
<span class="nv">Transferring</span><span class="w"> </span><span class="mi">11</span><span class="w"> </span><span class="nv">Files</span>...<span class="w"> </span><span class="nv">Done</span>
</code></pre></div>

<div class="highlight"><pre><span></span><code><span class="kn">from</span> <span class="nn">matplotlib</span> <span class="kn">import</span> <span class="n">pyplot</span> <span class="k">as</span> <span class="n">plt</span>
<span class="n">fig</span><span class="p">,</span> <span class="n">axs</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">4</span><span class="p">,</span> <span class="mi">2</span><span class="p">),</span> <span class="n">dpi</span><span class="o">=</span><span class="mi">150</span><span class="p">)</span>
<span class="n">axs</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">angles</span><span class="p">,</span> <span class="p">[</span><span class="mf">27.2114</span> <span class="o">*</span> <span class="p">(</span><span class="n">x</span> <span class="o">-</span> <span class="nb">min</span><span class="p">(</span><span class="n">ds</span><span class="o">.</span><span class="n">results</span><span class="p">))</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">ds</span><span class="o">.</span><span class="n">results</span><span class="p">],</span> <span class="s1">&#39;ro&#39;</span><span class="p">)</span>
<span class="n">axs</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s2">&quot;Energy shift (eV)&quot;</span><span class="p">)</span>
<span class="n">_</span> <span class="o">=</span> <span class="n">axs</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s2">&quot;Angle (degrees)&quot;</span><span class="p">)</span>
</code></pre></div>

<p><img alt="Energy vs. Angle" src="https://william-dawson.github.io/assets/explore/output_30_0.png"></p>
<h2>From Data to Machine Learning</h2>
<p>One of my motivations for this blog post was to test out a machine learning descriptors inside <a href="https://singroup.github.io/dscribe/latest/">DScribe</a>. First, create the descriptors. </p>
<div class="highlight"><pre><span></span><code><span class="kn">from</span> <span class="nn">BigDFT.Interop.ASEInterop</span> <span class="kn">import</span> <span class="n">bigdft_to_ase</span>
<span class="n">structures</span> <span class="o">=</span> <span class="p">[]</span>
<span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">steps</span><span class="p">):</span>
    <span class="n">structures</span> <span class="o">+=</span> <span class="p">[</span><span class="n">bigdft_to_ase</span><span class="p">(</span><span class="n">generate_rotated</span><span class="p">(</span><span class="s2">&quot;mol&quot;</span><span class="p">,</span> <span class="n">angles</span><span class="p">[</span><span class="n">i</span><span class="p">]))]</span>
</code></pre></div>

<div class="highlight"><pre><span></span><code><span class="kn">from</span> <span class="nn">dscribe.descriptors</span> <span class="kn">import</span> <span class="n">SOAP</span>
<span class="n">soap</span> <span class="o">=</span> <span class="n">SOAP</span><span class="p">(</span><span class="n">species</span><span class="o">=</span><span class="nb">set</span><span class="p">([</span><span class="n">x</span><span class="o">.</span><span class="n">sym</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">sys</span><span class="o">.</span><span class="n">get_atoms</span><span class="p">()]),</span> <span class="n">periodic</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> 
            <span class="n">r_cut</span><span class="o">=</span><span class="mf">5.0</span><span class="p">,</span> <span class="n">n_max</span><span class="o">=</span><span class="mi">8</span><span class="p">,</span> <span class="n">l_max</span><span class="o">=</span><span class="mi">8</span><span class="p">)</span>
<span class="n">X</span> <span class="o">=</span> <span class="p">[</span><span class="n">soap</span><span class="o">.</span><span class="n">create</span><span class="p">(</span><span class="n">s</span><span class="p">)</span><span class="o">.</span><span class="n">flatten</span><span class="p">()</span> <span class="k">for</span> <span class="n">s</span> <span class="ow">in</span> <span class="n">structures</span><span class="p">]</span>
</code></pre></div>

<p>We will try linear regression as our model (since this is linear regression, we can stick to the local machine).</p>
<div class="highlight"><pre><span></span><code><span class="kn">from</span> <span class="nn">sklearn.linear_model</span> <span class="kn">import</span> <span class="n">LinearRegression</span>
<span class="n">model</span> <span class="o">=</span> <span class="n">LinearRegression</span><span class="p">()</span>
<span class="n">_</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">X</span><span class="p">,</span> <span class="n">ds</span><span class="o">.</span><span class="n">results</span><span class="p">)</span>
</code></pre></div>

<p>Now predict some additional values.</p>
<div class="highlight"><pre><span></span><code><span class="n">steps</span> <span class="o">=</span> <span class="p">(</span><span class="n">steps</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="o">*</span> <span class="mi">2</span> <span class="o">+</span> <span class="mi">1</span>
<span class="n">pstructures</span> <span class="o">=</span> <span class="p">[]</span>
<span class="n">pangles</span> <span class="o">=</span> <span class="p">[]</span>
<span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">steps</span><span class="p">):</span>
    <span class="n">pangles</span> <span class="o">+=</span> <span class="p">[</span><span class="mi">120</span> <span class="o">/</span> <span class="p">(</span><span class="n">steps</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="o">*</span> <span class="n">i</span><span class="p">]</span>
    <span class="n">pstructures</span> <span class="o">+=</span> <span class="p">[</span><span class="n">bigdft_to_ase</span><span class="p">(</span><span class="n">generate_rotated</span><span class="p">(</span><span class="s2">&quot;mol&quot;</span><span class="p">,</span> <span class="n">pangles</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]))]</span>
</code></pre></div>

<div class="highlight"><pre><span></span><code><span class="n">X</span> <span class="o">=</span> <span class="p">[</span><span class="n">soap</span><span class="o">.</span><span class="n">create</span><span class="p">(</span><span class="n">s</span><span class="p">)</span><span class="o">.</span><span class="n">flatten</span><span class="p">()</span> <span class="k">for</span> <span class="n">s</span> <span class="ow">in</span> <span class="n">pstructures</span><span class="p">]</span>
<span class="n">predictions</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">predict</span><span class="p">(</span><span class="n">X</span><span class="p">)</span>
</code></pre></div>

<div class="highlight"><pre><span></span><code><span class="n">fig</span><span class="p">,</span> <span class="n">axs</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">4</span><span class="p">,</span> <span class="mi">2</span><span class="p">),</span> <span class="n">dpi</span><span class="o">=</span><span class="mi">150</span><span class="p">)</span>
<span class="n">axs</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">angles</span><span class="p">,</span> <span class="p">[</span><span class="mf">27.2114</span> <span class="o">*</span> <span class="p">(</span><span class="n">x</span> <span class="o">-</span> <span class="nb">min</span><span class="p">(</span><span class="n">ds</span><span class="o">.</span><span class="n">results</span><span class="p">))</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">ds</span><span class="o">.</span><span class="n">results</span><span class="p">],</span> 
         <span class="s1">&#39;ro&#39;</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s2">&quot;computed&quot;</span><span class="p">)</span>
<span class="n">axs</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">pangles</span><span class="p">,</span> <span class="p">[</span><span class="mf">27.2114</span> <span class="o">*</span> <span class="p">(</span><span class="n">x</span> <span class="o">-</span> <span class="nb">min</span><span class="p">(</span><span class="n">ds</span><span class="o">.</span><span class="n">results</span><span class="p">))</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">predictions</span><span class="p">],</span> 
         <span class="s1">&#39;k.&#39;</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s2">&quot;predicted&quot;</span><span class="p">)</span>
<span class="n">axs</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s2">&quot;Energy shift (eV)&quot;</span><span class="p">)</span>
<span class="n">axs</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s2">&quot;Angle (degrees)&quot;</span><span class="p">)</span>
<span class="n">_</span> <span class="o">=</span> <span class="n">axs</span><span class="o">.</span><span class="n">legend</span><span class="p">()</span>
</code></pre></div>

<p><img alt="Comparison of the data computed" src="https://william-dawson.github.io/assets/explore/output_39_0.png"></p>
<p>You could imagine that as the machine learning part gets more heavy, you move that to the remote machine as well thanks to remotemanager.</p>
        </section>

        <br><br><br>

 <!--        <footer>
          <div class="adjust-width">
            <div id="author-block" class="w3-light-grey w3-border">
              <div id="author-info">
                <a href=""><img style="width: 60px; height: 60px;" src="" onerror="this.src='images/avatar.png'" alt="Avatar"></a>
                <div style="margin-left: 20px; margin-top: 15px;">
                  <a href=""><span id="author-name" class="w3-hover-text-dark-grey">William Dawson</span></a>
                  <p id="author-story"></p>
                </div>
              </div>
            </div>
          </div>

          <br><br><br>

          <p style="font-size:10pt; font-style: italic;">Did you like this article? Share it with your friends!</p>
          <div id="share" class="share">
            <a href="http://www.facebook.com/sharer.php?u=https%3A//william-dawson.github.io/exploratory-data-science-on-supercomputers-for-quantum-mechanical-calculations.html&amp;t=william-dawson.github.io%3A%20Exploratory%20data%20science%20on%20supercomputers%20for%20quantum%20mechanical%20calculations" target="_blank" class="w3-btn w3-indigo">
              <i class="fa fa-facebook"></i> <span>Facebook</span>
            </a>
            <a href="http://twitter.com/share?url=https%3A//william-dawson.github.io/exploratory-data-science-on-supercomputers-for-quantum-mechanical-calculations.html&amp;text=william-dawson.github.io%3A%20Exploratory%20data%20science%20on%20supercomputers%20for%20quantum%20mechanical%20calculations" target="_blank" class="w3-btn w3-blue">
              <i class="fa fa-twitter"></i> <span>Twitter</span>
            </a>
            <a href="https://plus.google.com/share?url=https%3A//william-dawson.github.io/exploratory-data-science-on-supercomputers-for-quantum-mechanical-calculations.html" onclick="javascript:window.open(this.href, '', 'menubar=no,toolbar=no,resizable=yes,scrollbars=yes,height=600,width=600');return false;" class="w3-btn w3-red">
              <i class="fa fa-google-plus"></i> <span>Google</span>
            </a>
          </div>

          <br><br><br>



        </footer> -->
      </div>
    </article>


    <footer id="footer">
      <div id="footer-copyright" class="w3-center w3-small w3-text-grey w3-padding-48">
        <span>&copy;  William Dawson  | <a href="https://william-dawson.github.io/feeds/all.atom.xml">Atom feed <i class="fa fa-rss" aria-hidden="true"></i></a></span>
      </div>
    </footer>



  </body>
</html>