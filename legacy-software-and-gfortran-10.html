<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">

    <title>Legacy Software and gfortran-10 &ndash; william-dawson.github.io</title>

    <!-- Meta -->
    <meta name="description" content="william-dawson.github.io &ndash; ">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">

    <!-- Social -->
    <meta property="article:author" content="William Dawson" />
    <meta property="article:section" content="Lessons" />
    <meta property="article:published_time" content="2020-08-08" />

    <meta property="og:type" content="article"/>
    <meta property="og:title" content="Legacy Software and gfortran-10"/>
    <meta property="og:description" content="A recent update to the gfortran program is breaking compiliation of many legacy software packages. I will describe the underlying cause and possible mitigation strategies."/>
    <meta property="og:site_name" content="william-dawson.github.io" />
    <meta property="og:url" content="https://william-dawson.github.io/Test-Website/legacy-software-and-gfortran-10.html"/>

    <meta name="twitter:card" content="summary">
    <meta name="twitter:title" content="Legacy Software and gfortran-10">
    <meta name="twitter:description" content="A recent update to the gfortran program is breaking compiliation of many legacy software packages. I will describe the underlying cause and possible mitigation strategies.">
    <meta name="twitter:url" content="https://william-dawson.github.io/Test-Website/legacy-software-and-gfortran-10.html">

    <!-- Feed -->
    <link rel="alternate" type="application/atom+xml" href="https://william-dawson.github.io/Test-Website/feeds/all.atom.xml" title="william-dawson.github.io Atom Feed" />

    <!-- CSS -->
    <link rel="stylesheet" type="text/css" href="https://fonts.googleapis.com/css?family=Open+Sans:regular,bold">
    <link rel="stylesheet" type="text/css" href="https://william-dawson.github.io/Test-Website/theme/css/w3.css">
    <link rel="stylesheet" type="text/css" href="https://william-dawson.github.io/Test-Website/theme/css/style.css">
    <link rel="stylesheet" type="text/css" href="https://william-dawson.github.io/Test-Website/theme/css/jqcloud.css">
    <link rel="stylesheet" type="text/css" href="https://william-dawson.github.io/Test-Website/theme/css/font-awesome.min.css">
    <link rel="stylesheet" type="text/css" href="https://william-dawson.github.io/Test-Website/theme/css/pygments-highlight-github.css">

    <!-- Icon -->

    <!-- JavaScript -->
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.1.0/jquery.min.js"></script>
    <script src="https://william-dawson.github.io/Test-Website/theme/js/jqcloud.min.js"></script>
    <script>
    MathJax = {
      tex: {
        inlineMath: [['$', '$'], ['\\(', '\\)']]
      },
      svg: {
        fontCache: 'global'
      }
    };
    </script>
    <script type="text/javascript" id="MathJax-script" async
      src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-svg.js">
    </script>

  </head>

  <body>
    <div class="w3-row w3-card w3-white">
      <header id="header">
        <a href="https://william-dawson.github.io/Test-Website" id="header-logo" title="Home">WD</a>
        <nav id="header-menu">
          <ul>
            <li class="w3-bottombar w3-border-white w3-hover-border-green"><a href="https://william-dawson.github.io/Test-Website/pages/about.html">About</a></li>
            <li class="w3-bottombar w3-border-white w3-hover-border-green"><a href="https://william-dawson.github.io/Test-Website/pages/projects.html">Projects</a></li>
            <li class="w3-bottombar w3-border-white w3-hover-border-green"><a href="https://william-dawson.github.io/Test-Website/pages/publications.html">Publications</a></li>
            <li class="w3-bottombar w3-border-white w3-hover-border-green"><a href="https://william-dawson.github.io/Test-Website/category/lessons.html">Lessons</a></li>
            <li class="w3-bottombar w3-border-white w3-hover-border-green"><a href="https://william-dawson.github.io/Test-Website/category/personal-blog.html">Personal Blog</a></li>
          </ul>
        </nav>
      </header>
    </div>



    <br><br><br>

    <article>
      <header class="w3-container col-main">
        <h1>Legacy Software and gfortran-10</h1>
        <div class="post-info">
          <div class="w3-opacity w3-margin-right w3-margin-bottom" style="flex-grow: 1;">
            <span><time datetime="2020-08-08T11:00:00+09:00">Sat 08 August 2020</time> in <a href="https://william-dawson.github.io/Test-Website/category/lessons.html" title="All articles in category Lessons">Lessons</a></span>
          </div>
          <div>
            <span class="w3-tag w3-light-grey w3-text-green w3-hover-green">
              <a href="https://william-dawson.github.io/Test-Website/tag/software.html" title="All articles with Software tag">#software</a>
            </span>
          </div>
        </div>
      </header>

      <br>


      <div class="col-main w3-container">
        <section id="content">
          <p>I don't follow any Fortran blogs. In fact, I'm not sure if any of them exist.
If there are such blogs though, I might expect them to be ablaze right now
about gfortran version 10 and all the legacy software is breaking.
What is the problem you ask? Well consider the following program, which wraps
up computing the eigenvectors of a matrix using LAPACK.</p>
<div class="highlight"><pre><span></span><code><span class="k">SUBROUTINE </span><span class="n">Routine</span><span class="p">(</span><span class="n">MatA</span><span class="p">,</span><span class="w"> </span><span class="n">MatV</span><span class="p">)</span><span class="w"></span>
<span class="w">  </span><span class="kt">DOUBLE PRECISION</span><span class="p">,</span><span class="w"> </span><span class="k">DIMENSION</span><span class="p">(:,:),</span><span class="w"> </span><span class="k">INTENT</span><span class="p">(</span><span class="n">IN</span><span class="p">)</span><span class="w"> </span><span class="kd">::</span><span class="w"> </span><span class="n">MatA</span><span class="w"></span>
<span class="w">  </span><span class="kt">DOUBLE PRECISION</span><span class="p">,</span><span class="w"> </span><span class="k">DIMENSION</span><span class="p">(:,:),</span><span class="w"> </span><span class="k">INTENT</span><span class="p">(</span><span class="n">INOUT</span><span class="p">)</span><span class="w"> </span><span class="kd">::</span><span class="w"> </span><span class="n">MatV</span><span class="w"></span>
<span class="w">  </span><span class="kt">CHARACTER</span><span class="p">,</span><span class="w"> </span><span class="k">PARAMETER</span><span class="w"> </span><span class="kd">::</span><span class="w"> </span><span class="n">job</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s1">&#39;V&#39;</span><span class="p">,</span><span class="w"> </span><span class="n">uplo</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s1">&#39;U&#39;</span><span class="w"></span>
<span class="w">  </span><span class="kt">INTEGER</span><span class="w"> </span><span class="kd">::</span><span class="w"> </span><span class="n">N</span><span class="p">,</span><span class="w"> </span><span class="n">LDA</span><span class="w"></span>
<span class="w">  </span><span class="kt">DOUBLE PRECISION</span><span class="p">,</span><span class="w"> </span><span class="k">DIMENSION</span><span class="p">(:),</span><span class="w"> </span><span class="k">ALLOCATABLE</span><span class="w"> </span><span class="kd">::</span><span class="w"> </span><span class="n">W</span><span class="w"></span>
<span class="w">  </span><span class="kt">DOUBLE PRECISION</span><span class="p">,</span><span class="w"> </span><span class="k">DIMENSION</span><span class="p">(:),</span><span class="w"> </span><span class="k">ALLOCATABLE</span><span class="w"> </span><span class="kd">::</span><span class="w"> </span><span class="n">WORK</span><span class="w"></span>
<span class="w">  </span><span class="kt">DOUBLE PRECISION</span><span class="w"> </span><span class="kd">::</span><span class="w"> </span><span class="n">WORKTEMP</span><span class="w"></span>
<span class="w">  </span><span class="kt">INTEGER</span><span class="w"> </span><span class="kd">::</span><span class="w"> </span><span class="n">LWORK</span><span class="w"></span>
<span class="w">  </span><span class="kt">INTEGER</span><span class="p">,</span><span class="w"> </span><span class="k">DIMENSION</span><span class="p">(:),</span><span class="w"> </span><span class="k">ALLOCATABLE</span><span class="w"> </span><span class="kd">::</span><span class="w"> </span><span class="n">IWORK</span><span class="w"></span>
<span class="w">  </span><span class="kt">INTEGER</span><span class="w"> </span><span class="kd">::</span><span class="w"> </span><span class="n">IWORKTEMP</span><span class="w"></span>
<span class="w">  </span><span class="kt">INTEGER</span><span class="w"> </span><span class="kd">::</span><span class="w"> </span><span class="n">LIWORK</span><span class="w"></span>
<span class="w">  </span><span class="kt">INTEGER</span><span class="w"> </span><span class="kd">::</span><span class="w"> </span><span class="n">INFO</span><span class="w"></span>
<span class="w">  </span><span class="kt">INTEGER</span><span class="w"> </span><span class="kd">::</span><span class="w"> </span><span class="n">II</span><span class="w"></span>

<span class="w">  </span><span class="n">MatV</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">MatA</span><span class="w"></span>

<span class="w">  </span><span class="n">N</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">SIZE</span><span class="p">(</span><span class="n">MatA</span><span class="p">,</span><span class="nb">DIM</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span><span class="w"></span>
<span class="w">  </span><span class="n">LDA</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">N</span><span class="w"></span>

<span class="w">  </span><span class="c">!! Allocations</span>
<span class="w">  </span><span class="k">ALLOCATE</span><span class="p">(</span><span class="n">W</span><span class="p">(</span><span class="n">N</span><span class="p">))</span><span class="w"></span>

<span class="w">  </span><span class="c">!! Determine the scratch space size</span>
<span class="w">  </span><span class="n">LWORK</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">-</span><span class="mi">1</span><span class="w"></span>
<span class="w">  </span><span class="k">CALL </span><span class="n">DSYEVD</span><span class="p">(</span><span class="n">JOB</span><span class="p">,</span><span class="w"> </span><span class="n">UPLO</span><span class="p">,</span><span class="w"> </span><span class="n">N</span><span class="p">,</span><span class="w"> </span><span class="n">MatA</span><span class="p">,</span><span class="w"> </span><span class="n">LDA</span><span class="p">,</span><span class="w"> </span><span class="n">W</span><span class="p">,</span><span class="w"> </span><span class="p">&amp;</span><span class="w"></span>
<span class="w">       </span><span class="p">&amp;</span><span class="w"> </span><span class="n">WORKTEMP</span><span class="p">,</span><span class="w"> </span><span class="n">LWORK</span><span class="p">,</span><span class="w"> </span><span class="p">&amp;</span><span class="w"></span>
<span class="w">       </span><span class="p">&amp;</span><span class="w"> </span><span class="n">IWORKTEMP</span><span class="p">,</span><span class="w"> </span><span class="n">LIWORK</span><span class="p">,</span><span class="w"> </span><span class="p">&amp;</span><span class="w"></span>
<span class="w">       </span><span class="p">&amp;</span><span class="w"> </span><span class="n">INFO</span><span class="p">)</span><span class="w"></span>
<span class="w">  </span><span class="n">N</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">LDA</span><span class="w"></span>
<span class="w">  </span><span class="n">LWORK</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">INT</span><span class="p">(</span><span class="n">WORKTEMP</span><span class="p">)</span><span class="w"></span>
<span class="w">  </span><span class="k">ALLOCATE</span><span class="p">(</span><span class="n">WORK</span><span class="p">(</span><span class="n">LWORK</span><span class="p">))</span><span class="w"></span>
<span class="w">  </span><span class="n">LIWORK</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">INT</span><span class="p">(</span><span class="n">IWORKTEMP</span><span class="p">)</span><span class="w"></span>
<span class="w">  </span><span class="k">ALLOCATE</span><span class="p">(</span><span class="n">IWORK</span><span class="p">(</span><span class="n">LIWORK</span><span class="p">))</span><span class="w"></span>

<span class="w">  </span><span class="c">!! Run Lapack For Real</span>
<span class="w">  </span><span class="k">CALL </span><span class="n">DSYEVD</span><span class="p">(</span><span class="n">JOB</span><span class="p">,</span><span class="w"> </span><span class="n">UPLO</span><span class="p">,</span><span class="w"> </span><span class="n">N</span><span class="p">,</span><span class="w"> </span><span class="n">MatV</span><span class="p">,</span><span class="w"> </span><span class="n">LDA</span><span class="p">,</span><span class="w"> </span><span class="n">W</span><span class="p">,</span><span class="w"> </span><span class="p">&amp;</span><span class="w"></span>
<span class="w">       </span><span class="p">&amp;</span><span class="w"> </span><span class="n">WORK</span><span class="p">,</span><span class="w"> </span><span class="n">LWORK</span><span class="p">,</span><span class="w"> </span><span class="p">&amp;</span><span class="w"></span>
<span class="w">       </span><span class="p">&amp;</span><span class="w"> </span><span class="n">IWORK</span><span class="p">,</span><span class="w"> </span><span class="n">LIWORK</span><span class="p">,</span><span class="w"> </span><span class="p">&amp;</span><span class="w"></span>
<span class="w">       </span><span class="p">&amp;</span><span class="w"> </span><span class="n">INFO</span><span class="p">)</span><span class="w"></span>

<span class="w">  </span><span class="c">!! Cleanup</span>
<span class="w">  </span><span class="k">DEALLOCATE</span><span class="p">(</span><span class="n">W</span><span class="p">)</span><span class="w"></span>
<span class="w">  </span><span class="k">DEALLOCATE</span><span class="p">(</span><span class="n">Work</span><span class="p">)</span><span class="w"></span>
<span class="w">  </span><span class="k">DEALLOCATE</span><span class="p">(</span><span class="n">IWork</span><span class="p">)</span><span class="w"></span>

<span class="k">END SUBROUTINE </span><span class="n">Routine</span><span class="w"></span>
</code></pre></div>

<p>The important thing to note here is the two calls to <code>DSYEVD</code>. We perform
two calls because the first one tells us the required scratch space size,
and the second performs the actual decomposition. There is a subtle point
about these calls. In the first call we pass <code>WORKTEMP</code> and <code>IWORKTEMP</code> which
are double precision and integer variables. In the second, we pass the actual
scratch space arrays. If we compile this code with gfortran version 9, there
are no problems. But with version 10 we get the following errors:</p>
<div class="highlight"><pre><span></span><code>   27 |        &amp; WORKTEMP, LWORK, &amp;
      |         2
......
   38 |        &amp; WORK, LWORK, &amp;
      |         1
Error: Rank mismatch between actual argument at (1) and actual argument at (2) (scalar and rank-1)
</code></pre></div>

<p>The solution is simple: change the variables <code>WORKTEMP</code> and <code>IWORKTEMP</code> to be
arrays of length one, and now the arguments match. Another time I've seen this
come up is in old code that does something like this:</p>
<div class="highlight"><pre><span></span><code><span class="k">CALL </span><span class="n">DCOPY</span><span class="p">(</span><span class="n">NX</span><span class="p">,</span><span class="w"> </span><span class="n">ZERO</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="n">ARRAY1</span><span class="p">(</span><span class="mi">1</span><span class="p">:</span><span class="n">NX</span><span class="p">),</span><span class="w"> </span><span class="mi">1</span><span class="p">)</span><span class="w"></span>
<span class="p">...</span><span class="w"></span>
<span class="k">CALL </span><span class="n">DCOPY</span><span class="p">(</span><span class="n">NX</span><span class="p">,</span><span class="w"> </span><span class="n">ARRAY1</span><span class="p">,</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="n">ARRAY2</span><span class="p">,</span><span class="w"> </span><span class="mi">1</span><span class="p">)</span><span class="w"></span>
</code></pre></div>

<p>In the first case, we're using <code>dcopy</code> to initialize some memory to zero. In
the second, we're using it as a memcopy. I'm not sure why other programmers
didn't just use the assignment operator to initialize the memory, though I
wouldn't be surprised if older compilers weren't always optimal.</p>
<p>One final place I've encountered these kinds of errors is in calls to MPI.
Fortunately, placing the <code>USE MPI</code> statement in your code can resolve this
(and should have been there in the first place to prevent bugs).</p>
<p>These errors can be resolved with a flag like <code>--std=legacy</code>, but this is
for sure a good time to bring legacy code up to spec. Version 10 is already
available on homebrew, so if you have Mac users now is the time to check
your code!</p>
        </section>

        <br><br><br>

 <!--        <footer>
          <div class="adjust-width">
            <div id="author-block" class="w3-light-grey w3-border">
              <div id="author-info">
                <a href=""><img style="width: 60px; height: 60px;" src="" onerror="this.src='images/avatar.png'" alt="Avatar"></a>
                <div style="margin-left: 20px; margin-top: 15px;">
                  <a href=""><span id="author-name" class="w3-hover-text-dark-grey">William Dawson</span></a>
                  <p id="author-story"></p>
                </div>
              </div>
            </div>
          </div>

          <br><br><br>

          <p style="font-size:10pt; font-style: italic;">Did you like this article? Share it with your friends!</p>
          <div id="share" class="share">
            <a href="http://www.facebook.com/sharer.php?u=https%3A//william-dawson.github.io/Test-Website/legacy-software-and-gfortran-10.html&amp;t=william-dawson.github.io%3A%20Legacy%20Software%20and%20gfortran-10" target="_blank" class="w3-btn w3-indigo">
              <i class="fa fa-facebook"></i> <span>Facebook</span>
            </a>
            <a href="http://twitter.com/share?url=https%3A//william-dawson.github.io/Test-Website/legacy-software-and-gfortran-10.html&amp;text=william-dawson.github.io%3A%20Legacy%20Software%20and%20gfortran-10" target="_blank" class="w3-btn w3-blue">
              <i class="fa fa-twitter"></i> <span>Twitter</span>
            </a>
            <a href="https://plus.google.com/share?url=https%3A//william-dawson.github.io/Test-Website/legacy-software-and-gfortran-10.html" onclick="javascript:window.open(this.href, '', 'menubar=no,toolbar=no,resizable=yes,scrollbars=yes,height=600,width=600');return false;" class="w3-btn w3-red">
              <i class="fa fa-google-plus"></i> <span>Google</span>
            </a>
          </div>

          <br><br><br>



        </footer> -->
      </div>
    </article>


    <footer id="footer">
      <div id="footer-copyright" class="w3-center w3-small w3-text-grey w3-padding-48">
        <span>&copy;  William Dawson  | <a href="https://william-dawson.github.io/Test-Website/feeds/all.atom.xml">Atom feed <i class="fa fa-rss" aria-hidden="true"></i></a></span>
      </div>
    </footer>



  </body>
</html>